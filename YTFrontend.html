<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LibreWatch</title>
<style>
  body {
    font-family: sans-serif;
    background: #111;
    color: #eee;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
  }
  .player-container {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 1rem;
  }
  .player {
    width: 320px;
    height: 180px;
  }
  iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 12px;
  }
  input, select, button {
    padding: 0.5rem;
    margin: 0.25rem;
    font-size: 1rem;
  }
</style>
</head>
<body>

<h1>LibreWatch Multi-Endpoint Player</h1>

<div>
  <input id="videoInput" placeholder="YouTube URL or Video ID" value="dQw4w9WgXcQ">
  <button id="loadBtn">Load on All Endpoints</button>
</div>

<div class="player-container" id="playerContainer"></div>

<script>
const videoInput = document.getElementById("videoInput");
const loadBtn = document.getElementById("loadBtn");
const playerContainer = document.getElementById("playerContainer");

const endpoints = [
  { name: "Piped", url: "https://piped.video/" },
  { name: "Piped FrontendPrivacy", url: "https://pipedapi.frontendfriendly.xyz/" },
  { name: "Piped kavin.rocks", url: "https://pipedapi.kavin.rocks/" },
  { name: "Invidious Nadeko", url: "https://inv.nadeko.net/" },
  { name: "Invidious NerdVPN", url: "https://invidious.nerdvpn.de/" }
];

/* Extract clean video ID */
function extractVideoID(input) {
  try {
    if (input.includes("youtube.com") || input.includes("youtu.be")) {
      const url = new URL(input);
      return url.searchParams.get("v") || url.pathname.split("/").pop();
    }
    return input.trim();
  } catch {
    return input.trim();
  }
}

/* Fetch first SponsorBlock skip segment */
async function getFirstSkip(videoId) {
  try {
    const res = await fetch(`https://sponsor.ajay.app/api/skipSegments?videoID=${videoId}`);
    if (!res.ok) return 0;
    const data = await res.json();
    if (data.length && data[0].segment[0] === 0) return Math.floor(data[0].segment[1]);
    return 0;
  } catch {
    return 0;
  }
}

/* Create all players */
async function loadPlayers() {
  const rawInput = videoInput.value;
  const videoId = extractVideoID(rawInput);
  if (!videoId) return alert("Enter a valid video ID or URL.");

  const startTime = await getFirstSkip(videoId);

  playerContainer.innerHTML = ""; // clear old players

  endpoints.forEach(ep => {
    const wrapper = document.createElement("div");
    wrapper.className = "player";

    const iframe = document.createElement("iframe");
    iframe.src = `${ep.url}embed/${videoId}?autoplay=1&start=${startTime}`;
    iframe.allow = "autoplay; encrypted-media; picture-in-picture";
    iframe.title = ep.name;

    wrapper.appendChild(iframe);
    playerContainer.appendChild(wrapper);
  });
}

loadBtn.addEventListener("click", loadPlayers);
window.addEventListener("DOMContentLoaded", loadPlayers);
</script>
</body>
</html>
