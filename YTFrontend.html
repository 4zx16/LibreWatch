<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LibreWatch Player</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; display: flex; flex-direction: column; align-items: center; padding: 2rem; }
    #container { width: 640px; max-width: 95vw; height: 360px; margin-bottom: 1rem; }
    iframe { width: 100%; height: 100%; border: none; border-radius: 12px; }
    select, button { padding: 0.5rem; margin: 0.25rem; font-size: 1rem; }
  </style>
</head>
<body>
  <h1>LibreWatch Player</h1>
  <div>
    <label for="endpoint">Endpoint:</label>
    <select id="endpoint">
      <option value="https://piped.video/">Piped</option>
      <option value="https://pipedapi.frontendfriendly.xyz/">Frontendprivacy</option>
      <option value="https://pipedapi.kavin.rocks/">kavin.rocks</option>
    </select>
    <input type="text" id="videoId" placeholder="YouTube Video ID" value="dQw4w9WgXcQ">
    <button id="loadBtn">Load Video</button>
  </div>
  <div id="container"></div>

  <script type="module">
    import { config } from './Player/config.js';

    const container = document.getElementById('container');
    const endpointSelect = document.getElementById('endpoint');
    const videoInput = document.getElementById('videoId');
    const loadBtn = document.getElementById('loadBtn');

    async function proxyFetch(url, proxyList = ['CorsProxy', 'AllOriginsRaw', 'AllOriginsJSON', 'CorsProxy2']) {
      for (const proxyName of proxyList) {
        const proxyUrl = config.Proxy[proxyName];
        if (!proxyUrl) continue;
        try {
          const res = await fetch(proxyUrl + encodeURIComponent(url));
          if (res.ok) return res;
        } catch (e) {
          console.warn(`Proxy ${proxyName} failed:`, e);
        }
      }
      throw new Error('All proxies failed');
    }

    async function loadSponsorSegments(videoId) {
      try {
        const url = `${config.sponsorBlock}api/skipSegments?videoID=${videoId}`;
        const res = await proxyFetch(url);
        const data = await res.json();
        console.log('SponsorBlock segments:', data);
        return data.sort((a,b)=>a.segment[0]-b.segment[0]);
      } catch(e) {
        console.warn('SponsorBlock fetch failed:', e);
        return [];
      }
    }

    function createIframe(endpoint, videoId, startTime=0) {
      container.innerHTML = '';
      const iframe = document.createElement('iframe');

      (async () => {
        const proxyList = ['CorsProxy', 'AllOriginsRaw', 'AllOriginsJSON', 'CorsProxy2'];
        let loaded = false;
        for (const proxyName of proxyList) {
          try {
            const proxyUrl = config.Proxy[proxyName] + encodeURIComponent(`${endpoint}watch?v=${videoId}&start=${Math.floor(startTime)}&autoplay=1`);
            iframe.src = proxyUrl;
            loaded = true;
            break;
          } catch(e) {
            console.warn(`Iframe proxy ${proxyName} failed:`, e);
          }
        }
        if (!loaded) {
          iframe.src = `${endpoint}watch?v=${videoId}&start=${Math.floor(startTime)}&autoplay=1`;
          console.warn('All proxies failed, using direct URL (may hit CORS)');
        }
      })();

      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.sandbox = 'allow-scripts allow-same-origin allow-presentation';
      iframe.referrerPolicy = 'no-referrer';
      container.appendChild(iframe);
      return iframe;
    }

    async function loadPlayer() {
      const videoId = videoInput.value.trim();
      if (!videoId) return alert('Enter a video ID!');
      const endpoint = endpointSelect.value;

      const segments = await loadSponsorSegments(videoId);
      // Currently just logging segments; can add auto-skip logic later
      console.log('Segments loaded:', segments);

      createIframe(endpoint, videoId);
    }

    loadBtn.addEventListener('click', loadPlayer);

    // Optionally load default video on page load
    window.addEventListener('DOMContentLoaded', loadPlayer);
  </script>
</body>
</html>
