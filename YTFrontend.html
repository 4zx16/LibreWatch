<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LibreWatch</title>
<style>
  body {
    font-family: sans-serif;
    background: #111;
    color: #eee;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
  }
  #player {
    width: 640px;
    max-width: 95vw;
    height: 360px;
    margin-top: 1rem;
  }
  iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 12px;
  }
  input, select, button {
    padding: 0.5rem;
    margin: 0.25rem;
    font-size: 1rem;
  }
</style>
</head>
<body>

<h1>LibreWatch</h1>

<div>
  <select id="endpoint">
    <option value="https://piped.video/">Piped</option>
    <option value="https://inv.nadeko.net/">Invidious (Nadeko)</option>
    <option value="https://invidious.nerdvpn.de/">Invidious (NerdVPN)</option>
  </select>

  <input id="videoInput" placeholder="YouTube URL or Video ID"
         value="dQw4w9WgXcQ">

  <button id="loadBtn">Load</button>
</div>

<div id="player"></div>

<script type="module">

const endpointSelect = document.getElementById("endpoint");
const videoInput = document.getElementById("videoInput");
const loadBtn = document.getElementById("loadBtn");
const playerContainer = document.getElementById("player");

/* Extract clean video ID */
function extractVideoID(input) {
  try {
    if (input.includes("youtube.com") || input.includes("youtu.be")) {
      const url = new URL(input);
      return url.searchParams.get("v") || url.pathname.split("/").pop();
    }
    return input.trim();
  } catch {
    return input.trim();
  }
}

/* Fetch SponsorBlock (no proxy needed) */
async function getSponsorSegments(videoId) {
  try {
    const res = await fetch(
      `https://sponsor.ajay.app/api/skipSegments?videoID=${videoId}`
    );
    if (!res.ok) return [];
    const data = await res.json();
    return data.sort((a,b) => a.segment[0] - b.segment[0]);
  } catch {
    return [];
  }
}

/* Create iframe */
function createPlayer(endpoint, videoId, startTime = 0) {
  playerContainer.innerHTML = "";
  const iframe = document.createElement("iframe");
  iframe.src =
    `${endpoint}watch?v=${videoId}` +
    (startTime ? `&start=${Math.floor(startTime)}` : "") +
    `&autoplay=1`;

  iframe.allow =
    "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
  iframe.referrerPolicy = "no-referrer";
  iframe.sandbox =
    "allow-scripts allow-same-origin allow-presentation";

  playerContainer.appendChild(iframe);
}

/* Main load */
async function loadVideo() {
  const rawInput = videoInput.value;
  const videoId = extractVideoID(rawInput);
  const endpoint = endpointSelect.value;

  if (!videoId) {
    alert("Enter a valid video ID or URL.");
    return;
  }

  const segments = await getSponsorSegments(videoId);

  let startTime = 0;

  // Optional: auto-skip intro if first segment starts at 0
  if (segments.length && segments[0].segment[0] === 0) {
    startTime = segments[0].segment[1];
  }

  createPlayer(endpoint, videoId, startTime);

  console.log("SponsorBlock segments:", segments);
}

loadBtn.addEventListener("click", loadVideo);
window.addEventListener("DOMContentLoaded", loadVideo);

</script>
</body>
</html>
